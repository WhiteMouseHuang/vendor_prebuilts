From 311e613368f5967e2c93404da4427cb700ff9feb Mon Sep 17 00:00:00 2001
From: jhenrique09 <jhenrique09.mcz@hotmail.com>
Date: Fri, 27 Mar 2020 22:48:17 -0300
Subject: [PATCH] fwb: Guard some functions against face unlock

Change-Id: I26d6f6d9ead884aff361236d2e5aa202d90704ba
---
 .../android/systemui/biometrics/FODCircleView.java    |  7 +++++--
 .../statusbar/phone/KeyguardBottomAreaView.java       |  6 ++++--
 .../server/biometrics/BiometricServiceBase.java       | 11 ++++++++---
 3 files changed, 17 insertions(+), 7 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/biometrics/FODCircleView.java b/packages/SystemUI/src/com/android/systemui/biometrics/FODCircleView.java
index 13c33de467d..2b5eaf0f3a5 100644
--- a/packages/SystemUI/src/com/android/systemui/biometrics/FODCircleView.java
+++ b/packages/SystemUI/src/com/android/systemui/biometrics/FODCircleView.java
@@ -173,13 +173,16 @@ public class FODCircleView extends ImageView implements ConfigurationListener {
         @Override
         public void onBiometricRunningStateChanged(boolean running,
             BiometricSourceType biometricSourceType) {
-            dispatchFodFingerprintRunningStateChanged(running);
+            if (biometricSourceType == BiometricSourceType.FINGERPRINT){
+                dispatchFodFingerprintRunningStateChanged(running);
+            }
         }
 
         @Override
         public void onBiometricHelp(int msgId, String helpString,
                 BiometricSourceType biometricSourceType) {
-            if (msgId == -1){ // Auth error
+            if (biometricSourceType == BiometricSourceType.FINGERPRINT &&
+                    msgId == -1){ // Auth error
                 hideCircle();
                 mHandler.post(() -> mFODAnimation.hideFODanimation());
             }
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/phone/KeyguardBottomAreaView.java b/packages/SystemUI/src/com/android/systemui/statusbar/phone/KeyguardBottomAreaView.java
index 58061650671..cdcaaa52f4d 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/phone/KeyguardBottomAreaView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/phone/KeyguardBottomAreaView.java
@@ -730,8 +730,10 @@ public class KeyguardBottomAreaView extends FrameLayout implements View.OnClickL
                 @Override
                 public void onBiometricRunningStateChanged(boolean running,
                             BiometricSourceType biometricSourceType) {
-                    mIsFingerprintRunning = running;
-                    updateIndicationAreaPadding();
+                    if (biometricSourceType == BiometricSourceType.FINGERPRINT){
+                        mIsFingerprintRunning = running;
+                        updateIndicationAreaPadding();
+                    }
                 }
             };
 
diff --git a/services/core/java/com/android/server/biometrics/BiometricServiceBase.java b/services/core/java/com/android/server/biometrics/BiometricServiceBase.java
index 69a441de4c1..8352d56d2d0 100644
--- a/services/core/java/com/android/server/biometrics/BiometricServiceBase.java
+++ b/services/core/java/com/android/server/biometrics/BiometricServiceBase.java
@@ -656,11 +656,16 @@ public abstract class BiometricServiceBase extends SystemService
         mPowerManager = mContext.getSystemService(PowerManager.class);
         mUserManager = UserManager.get(mContext);
         mMetricsLogger = new MetricsLogger();
-        mCleanupUnusedFingerprints = mContext.getResources().getBoolean(
+        mCleanupUnusedFingerprints = statsModality() == BiometricsProtoEnums.MODALITY_FINGERPRINT &&
+                mContext.getResources().getBoolean(
                 com.android.internal.R.bool.config_cleanupUnusedFingerprints);
-        mNotifyClient = mContext.getResources().getBoolean(
+        mNotifyClient =
+                statsModality() == BiometricsProtoEnums.MODALITY_FINGERPRINT &&
+                mContext.getResources().getBoolean(
                 com.android.internal.R.bool.config_notifyClientOnFingerprintCancelSuccess);
-        mPostResetRunnableForAllClients = mContext.getResources().getBoolean(
+        mPostResetRunnableForAllClients =
+                statsModality() == BiometricsProtoEnums.MODALITY_FINGERPRINT &&
+                mContext.getResources().getBoolean(
                 com.android.internal.R.bool.config_fingerprintPostResetRunnableForAllClients);
     }
 
-- 
2.26.0.windows.1

